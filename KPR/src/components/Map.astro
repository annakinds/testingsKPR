---
import "leaflet/dist/leaflet.css";
---

<div id="map" style="height:100vh;"></div>

<script>
    import L from "leaflet";

    const map = L.map("map").setView([50.8285, 3.264], 13);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "Â© OpenStreetMap",
    }).addTo(map);

    let selectedMarker = 0;

    fetch("/testingsKPR//data/KPR+Kortrijk.geojson")
        .then((r) => r.json())
        .then((data) => {
            L.geoJSON(data, {
                pointToLayer: (feature, latlng) => {
                    const isFeatured = feature.properties.featured;
                    const customIcon = L.icon({
                        iconUrl: isFeatured
                            ? "/testingsKPR/marker__yellow.svg"
                            : "/testingsKPR/marker__gray.svg",
                        iconSize: isFeatured ? [32, 32] : [24, 24],
                        iconAnchor: isFeatured ? [16, 32] : [12, 24],
                        popupAnchor: isFeatured ? [0, -32] : [0, -24],
                    });
                    return L.marker(latlng, { icon: customIcon });
                },
                onEachFeature(feature, layer) {
                    layer.feature = feature;
                    const coords = feature.geometry.coordinates;
                    const routeUrl = `https://www.google.com/maps/dir/?api=1&destination=${coords[1]},${coords[0]}`;

                    let popup = `
                     <div class="card">
                     
                         <div class="card-header">
                             ${feature.properties.location || ""}
                         </div>
                     
                         <div class="card-body">
                     
                             ${
                                 feature.properties.image
                                     ? `<img src="${feature.properties.image}" class="card-image" />`
                                     : ""
                             }
                     
                             <div class="card-title">${feature.properties.name}</div>
                     
                             <a href="${routeUrl}" target="_blank" class="card-button">
                                 See route
                             </a>
                         </div>
                     
                     </div>
                     `;

                    layer.bindPopup(popup);

                    layer.on("click", () => {
                        if (selectedMarker) {
                            const isFeatured = feature.properties.featured;
                            const wasFeatured =
                                selectedMarker.feature.properties.featured;
                            selectedMarker.setIcon(
                                L.icon({
                                    iconUrl: wasFeatured
                                        ? "/testingsKPR/marker__yellow.svg"
                                        : "/testingsKPR/marker__gray.svg",
                                    iconSize: isFeatured ? [32, 32] : [24, 24],
                                    iconAnchor: isFeatured
                                        ? [16, 32]
                                        : [12, 24],
                                    popupAnchor: isFeatured
                                        ? [0, -32]
                                        : [0, -24],
                                }),
                            );
                        }
                        selectedMarker = layer;
                        layer.setIcon(
                            L.icon({
                                iconUrl: "/testingsKPR/marker__orange.svg",
                                iconSize: [32, 32],
                                iconAnchor: [16, 32],
                                popupAnchor: [0, -32],
                            }),
                        );
                    });
                },
            }).addTo(map);
        });
</script>

<style>
    :global(.card) {
        width: 17rem;
        background: #1b1b1b;
        border-radius: 0.75rem;
        overflow: hidden;
        padding-bottom: 1rem;
        font-family: Obviously, sans-serif;
    }

    :global(.card-header) {
        background: #ff6249;
        color: white;
        text-align: center;
        font-size: 2.5rem;
        font-weight: 560;
        padding: 0.7rem 0;
    }

    :global(.card-body) {
        padding: 1rem;
        text-align: center;
    }

    :global(.card-image) {
        width: 100%;
        height: 10rem;
        object-fit: contain;
        margin-bottom: 1rem;
    }

    :global(.card-title) {
        color: white;
        font-size: 2rem;
        font-weight: 560;
        margin-bottom: 1rem;
    }

    :global(.card-button) {
        display: inline-block;
        padding: 0.5rem 1.5rem;
        background: #d4f75f;
        border: 2px solid #1b1b1b;
        font-size: 1.25rem;
        font-weight: 500;
        color: #1b1b1b;
        text-decoration: none;
        outline: 5px solid #d4f75f;
        border-radius: 0.25rem;
    }

    :global(.leaflet-popup-content-wrapper) {
        background: transparent !important;
        box-shadow: none !important;
        border-radius: 0.75rem !important;
        padding: 0 !important;
    }

    :global(.leaflet-popup-content) {
        margin: 0 !important;
        padding: 0 !important;
    }

    :global(.leaflet-popup-tip) {
        background: #1b1b1b !important;
    }

    :global(.leaflet-tile) {
        filter: grayscale(100%) contrast(95%) brightness(95%);
    }
</style>
